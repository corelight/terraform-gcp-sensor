# NSI Traffic Selection - Security Profile and Mirroring Rules
# This configures which traffic gets mirrored to the sensor

# NOTE: Security profiles and security profile groups are created EXTERNALLY by IT team
# at the organization level. We reference them here using data sources.
# See IT_TEAM_COMMANDS.md for the commands IT needs to run.

# 1. Reference existing custom mirroring security profile (created by IT team)
data "google_network_security_security_profile" "mirror_profile" {
  name         = var.mirroring_profile_name
  organization = var.organization_id
  location     = "global"
}

# 2. Reference existing security profile group (created by IT team)
data "google_network_security_security_profile_group" "mirror_profile_group" {
  name         = var.mirroring_profile_group_name
  organization = var.organization_id
  location     = "global"
}

# 3. Create network firewall policy for each mirrored VPC
resource "google_compute_network_firewall_policy" "mirror_policies" {
  for_each = local.vpcs_map

  name        = "${each.value.network_name}-mirror-policy"
  project     = each.value.project_id
  description = "Firewall policy with mirroring rules for ${each.value.network_name}"
}

# 4. Create mirroring rule to mirror ingress traffic
resource "google_compute_network_firewall_policy_rule" "mirror_ingress" {
  for_each = local.vpcs_map

  action                 = "mirror"
  description            = "Mirror ingress traffic to Corelight sensor"
  direction              = "INGRESS"
  firewall_policy        = google_compute_network_firewall_policy.mirror_policies[each.key].name
  priority               = 1000
  rule_name              = "mirror-ingress-all"
  project                = each.value.project_id
  security_profile_group = google_network_security_security_profile_group.mirror_profile_group.id

  match {
    src_ip_ranges = var.mirroring_src_ip_ranges
    layer4_configs {
      ip_protocol = "all"
    }
  }
}

# 5. Create mirroring rule to mirror egress traffic
resource "google_compute_network_firewall_policy_rule" "mirror_egress" {
  for_each = local.vpcs_map

  action                 = "mirror"
  description            = "Mirror egress traffic to Corelight sensor"
  direction              = "EGRESS"
  firewall_policy        = google_compute_network_firewall_policy.mirror_policies[each.key].name
  priority               = 1001
  rule_name              = "mirror-egress-all"
  project                = each.value.project_id
  security_profile_group = google_network_security_security_profile_group.mirror_profile_group.id

  match {
    dest_ip_ranges = var.mirroring_dest_ip_ranges
    layer4_configs {
      ip_protocol = "all"
    }
  }
}

# 6. Associate the firewall policy with each VPC
resource "google_compute_network_firewall_policy_association" "mirror_associations" {
  for_each = local.vpcs_map

  name              = "${each.value.network_name}-mirror-association"
  attachment_target = each.value.network
  firewall_policy   = google_compute_network_firewall_policy.mirror_policies[each.key].name
  project           = each.value.project_id
}
